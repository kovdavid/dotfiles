#!/usr/bin/env perl

use utf8;
use v5.16;
use strict;
use warnings;

use JSON::XS;

$| = 1;

# Skip the first line which contains the version header.
print scalar <STDIN>;

# The second line contains the start of the infinite array.
print scalar <STDIN>;

my $layer_colors = [
    "#FFFFFF",
    "#00FF00",
    "#FFFF00",
    "#FF0000",
    "#FF00FF",
];

# Read lines forever, ignore a comma at the beginning if it exists.
while (my ($statusline) = (<STDIN> =~ /^,?(.*)/)) {
    my @blocks = @{decode_json($statusline)};

    if ( -f "/home/davs/workspace/avr/dalsik/utils/cmd_get_layer_index.pl" ) {
        my $result = `~/workspace/avr/dalsik/utils/cmd_get_layer_index.pl`;

        if ($result =~ /^(\d+)/) {
            my $layer = $1;
            if ($layer > 0) {
                unshift @blocks, {
                    full_text => "Dalsik layer [$layer]",
                    color => $layer_colors->[$layer] || $layer_colors->[0],
                };
            }
        }
    }

    print encode_json(\@blocks) . ",\n";
}
