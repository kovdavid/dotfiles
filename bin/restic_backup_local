#!/bin/bash

if [ ! -d /opt/backup ] ; then
    echo "Directory /opt/backup does not exist"
    echo "Run the following:"
    echo ""
    echo "sudo mkdir /opt/backup"
    echo "sudo chown davs:davs /opt/backup"
    echo "chmod g-rwx,o-rwx /opt/backup"
    echo "chmod g+s /opt/backup"
    echo "setfacl -d -m g::000 /opt/backup"
    echo "setfacl -d -m o::000 /opt/backup"
    exit 1
fi

cd /opt/backup

source .envrc

if ! restic snapshots &>/dev/null ; then
    echo "####### $(date '+%F %T') Initializing repository"
    restic init
fi

echo "####### $(date '+%F %T') Running backup"
restic backup --exclude-file /home/davs/dotfiles/rsync_ignore --exclude-caches --no-scan /home/davs

echo "####### $(date '+%F %T') Cleaning up old snapshots"
restic forget --keep-last 5 --keep-daily 7 --keep-weekly 4 --keep-monthly 1 --prune

echo "####### $(date '+%F %T') Checking repository"
restic check

echo "####### $(date '+%F %T') Current snapshots"
restic snapshots

echo "####### $(date '+%F %T') Directory sizes"
du -shc .??* * | sort -h

date '+%F %T' > last_backup
